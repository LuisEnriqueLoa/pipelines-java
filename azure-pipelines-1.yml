# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - main 

pool:
  vmImage: 'ubuntu-latest'

variables:
  mvnOpts: '-B -Dmaven.test.failure.ignore=false'
  jdkVersion: '17'

stages:
  - stage: Build
    displayName: 'Build'
    jobs:
    - job: BuildJob
      displayName: 'Build Job'
      steps:

        - task: Bash@3
          inputs:
            targetType: 'inline'
            script: |
              echo "JAVA_HOME: $JAVA_HOME"
              java -version
              
        #Task opcional si se requiere seleccionar el JDK
        - task: JavaToolInstaller@0
          displayName: 'Instalar JDK'
          inputs:
            versionSpec: '$(jdkVersion)'
            jdkArchitectureOption: x64
            jdkSourceOption: PreInstalled

        - task: Maven@4
          inputs:
            mavenPomFile: 'pom.xml'
            goals: 'clean package'
            options: '$(mvnOpts)'
            publishJUnitResults: true
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: '$(jdkVersion)'
            mavenVersionOption: 'Default'
            testResultsFiles: '**/surefire-reports/TEST-*.xml'
        
        - task: PublishBuildArtifacts@1
          displayName: 'Publicar Artefacto'
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)/target'
            ArtifactName: 'drop'
            publishLocation: 'Container'

#  - stage: Test
#    displayName: 'Test Stage'
#    dependsOn: Build
#    isSkippable: false
#    jobs:
#    - job: TestJob
#      displayName: 'Test Job'
#      steps:
#        - script: |
#            echo "Running unit test..."
#          displayName: 'Run unit tests'

#  - stage: DeployToStaging
#    displayName: 'Deploy to Staging'
#    dependsOn: Test
#    jobs:
#      - job: DeployStagingJob
#        displayName: 'Desploy to Staging Job'
#        pool: 
#          vmImage: 'ubuntu-latest'
#        steps:
#          - script: |
#              echo "Buils staging job..."
#            displayName: 'Build and deploy to staging'

#      - job: DeployStagingJobWithValidation
#        pool: server
#        timeoutInMinutes: 4320 
#        displayName: 'Deploy to Staging Job'
#        steps:
#          - task: ManualValidation@1
#            timeoutInMinutes: 1440
#            inputs:
#              notifyUsers: luisloa.7913@gmail.com
#              instructions: 'Por favor valida la etapa de configuraci√≥n y resumen'
#              onTimeout: 'resume'





